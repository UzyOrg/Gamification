<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0, viewport-fit=cover"
    />
    <title>RappiCard Legacy</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <img class="background" src="./background.png" alt="" />
    <p
      class="close-button"
      onclick="brazeBridge.logClick();brazeBridge.closeMessage()"
    >
      X
    </p>
    <div class="caracter-modal">
      <img
        class="background"
        src="https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d3d0d80700634db9fb/original.png?1723613648"
        alt=""
      />
      <p id="close-button-modal" class="close-button">X</p>
      <p class="caracter-modal-title" id="modal-title">¡GANASTE!</p>
      <div class="modal-lottie-container">
        <lottie-player
          class="modal-lottie"
          id="Ajolote-Level-1-Animacion"
          src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-2-Animacion.json"
          background="transparent"
          speed="1"
          direction="2"
          mode="normal"
          autoplay
          loop
        ></lottie-player>
      </div>
      <div class="recompensa-container">
        <p class="title">Recompensa</p>
        <hr />
        <div class="recompensa-description">
          <p>Ganaste 3% de cashback en tu siguinete compra</p>
        </div>
      </div>
      <div class="comercios-container">
        <img
          class="comercios"
          id="Liverpool"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a96a093640059747fdc/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="Shein"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a963d979000599f65f8/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="Nike"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a96835f4d0059913d9f/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="HomeDepot"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a96f97ace005a529f5b/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="MacStore"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a9656dcac005a169c84/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="AeroMexico"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/663e68ff755f2e00594909e9/original.png?1715366143"
          alt=""
        />
        <img
          class="comercios"
          id="VivaAero"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/663e690ea30d9d005928e993/original.png?1715366157"
          alt=""
        />
        <img
          class="comercios"
          id="Chedraui"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66359a96b52bf9005bec0c82/original.png?1714789013"
          alt=""
        />
        <img
          class="comercios"
          id="InnovaSport"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/663e68ff810a9c00594d13a7/original.png?1715366143"
          alt=""
        />
      </div>
      <button id="modal-button">Usar mi promo</button>
    </div>
    <div class="modal-overlay"></div>
    <div class="modal-info">
      <p id="close-modal-info" style="color: black; float: right">X</p>
    </div>
    <!-- Inician los niveles -->
    <div class="mainPage-container">
      <img
        class="img-title"
        src="https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41cffbc3f20064c786a6/original.png?1723613647"
        alt=""
      />
      <div class="mision-actual-container">
        <p class="mision-header">Misión Actual</p>
        <hr />
        <p id="meta-actual-text">...</p>
      </div>
      <div class="progress-container">
        <div class="column caracter-column">
          <div id="caracter-lvl-1" class="caracter-container">
            <lottie-player
              id="ajolote-1-discover-animation"
              class="caracter-animation caracter"
              src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-1-Icono.json"
              background="transparent"
              speed="1"
              direction="2"
              mode="normal"
            ></lottie-player>
            <div class="caracter-description">
              <span>Newbie</span>
            </div>
          </div>
          <div id="caracter-lvl-2" class="caracter-container">
            <lottie-player
              id="ajolote-2-discover-animation"
              class="caracter-animation caracter"
              src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-2-Icono.json"
              background="transparent"
              speed="1"
              direction="2"
              mode="normal"
            ></lottie-player>
            <div class="caracter-description">
              <span>Aprendiz</span>
            </div>
          </div>
          <div id="caracter-lvl-3" class="caracter-container">
            <lottie-player
              id="ajolote-3-discover-animation"
              class="caracter-animation caracter"
              src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-3-Icono.json"
              background="transparent"
              speed="1"
              direction="2"
              mode="normal"
            ></lottie-player>
            <div class="caracter-description">
              <span>Amateur</span>
            </div>
          </div>
          <div id="caracter-lvl-4" class="caracter-container">
            <lottie-player
              id="ajolote-4-discover-animation"
              class="caracter-animation caracter"
              src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
              background="transparent"
              speed="1"
              direction="2"
              mode="normal"
            ></lottie-player>
            <div class="caracter-description">
              <span>Wizard</span>
            </div>
          </div>
        </div>
        <div class="column rewards-column">
          <div id="progress-rewards" class="progress">
            <div class="info-tag tag-1" onclick="openModalInfo(1)"></div>
            <div class="chest chest-1">
            </div>
            <div class="info-tag tag-2" onclick="openModalInfo(2)"></div>
            <div class="chest chest-2">
            </div>
            <div class="info-tag tag-3" onclick="openModalInfo(3)"></div>
            <div class="chest chest-3">
            </div>
            <div class="info-tag tag-4" onclick="openModalInfo(4)"></div>
            <div class="chest chest-4">
            </div>
            <img
              class="progressBar"
              src="https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-2.png"
              alt=""
            />
          </div>
          <div class="progressBar-rewards">
            <div class="lvl-1-rewards rewards">
              <p>Premios</p>
              <ul>
                <li>cashback</li>
                <li>MSI</li>
              </ul>
            </div>
            <div class="lvl-2-rewards rewards">
              <p>Premios</p>
              <ul>
                <li>cashback</li>
                <li>MSI</li>
              </ul>
            </div>
            <div class="lvl-3-rewards rewards">
              <p>Premios</p>
              <ul>
                <li>cashback</li>
                <li>MSI</li>
              </ul>
            </div>
            <div class="lvl-4-rewards rewards">
              <p>Premios</p>
              <ul>
                <li>cashback</li>
                <li>MSI</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <button>Siguiente</button>
    </div>
  </body>
  <script>
    // Objeto que rellena toda la información de la app
    // --------------------------------------
    let object = {
      resultado: {
        isFirstTime: false /* boleano */,
        Logros: {
          Nivel: 5 /* Entero mayor a 0 */,
          hasFailed: false /* boleano */,
          semana: 1 /* Entero mayor a 0 */,
          comercio: "" /* String */,
        },
      },
      premioActual: "3% de cashback del 20 al 28 de Junio." /* String */,
      metaActual: "Haz una compra a MSI" /* String */,
      metas: [
        { meta: "", premio: "" },
        { meta: "", premio: "" },
      ] /* Array de objetos */,
    };
    // --------------------------------------

    const { Nivel, hasFailed, semana, comercio } = object.resultado.Logros;
    const { premioActual, metaActual, metas } = object;
    const { isFirstTime } = object.resultado;

    const caracterModal = document.querySelector(".caracter-modal");
    document.getElementById("meta-actual-text").innerText = metaActual;
    document
      .getElementById("close-button-modal")
      .addEventListener("click", () => {
        caracterModal.style.opacity = 0;
        setTimeout(() => {
          caracterModal.style.display = "none";
        }, 250);
      });
    const modalInfoCloseButton = document.getElementById("close-modal-info");
    modalInfoCloseButton.addEventListener("click", () => {
      console.log("haolasa");
      modalInfo = document.querySelector(".modal-info");
      overlay = document.querySelector(".modal-overlay");

      modalInfo.style.opacity = 0;
      overlay.style.opacity = 0;
      setTimeout(() => {
        modalInfo.style.display = "none";
        overlay.style.display = "none";
      }, 500);
    });
    function openModalInfo () {
      modalInfo = document.querySelector(".modal-info");
        overlay = document.querySelector(".modal-overlay");
        modalInfo.style.opacity = 1;
        overlay.style.opacity = 1;
        modalInfo.style.display = "block";
        overlay.style.display = "block";
    }
    function closeModalInfo () {
      modalInfo = document.querySelector(".modal-info");
        overlay = document.querySelector(".modal-overlay");
        modalInfo.style.opacity = 1;
        overlay.style.opacity = 1;
        modalInfo.style.display = "block";
        overlay.style.display = "block";
    }
    function createLevelElement(level, isFirstTime) {
      // Crear el elemento <div> principal
      const caracterReachedLoop = document.createElement("div");
      caracterReachedLoop.addEventListener("click", () => {
        updateModalContent(level, hasFailed);
      });
      caracterReachedLoop.id = `caracter-reached-loop-${level}`;
      caracterReachedLoop.className = "caracter-container caracter-loop";

      // Crear el elemento de caracter
      let caracterElement;
      if (isFirstTime) {
        // Usar lottie-player si es la primera vez
        caracterElement = document.createElement("lottie-player");
        caracterElement.setAttribute(
          "id",
          `ajolote-${level}-discover-animation`
        );
        caracterElement.setAttribute(
          "src",
          "https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
        ); // Siempre usar el JSON del nivel 4
        caracterElement.setAttribute("background", "transparent");
        caracterElement.setAttribute("speed", "1");
        caracterElement.setAttribute("direction", "1");
        caracterElement.setAttribute("mode", "normal");
        caracterElement.setAttribute("autoplay", "true");
        setTimeout(() => {
          document.querySelector(".caracter-modal").style.display = "flex";
          setTimeout(() => {
            updateModalContent(level, hasFailed);
            document.querySelector(".caracter-modal").style.opacity = 1;
          }, 100);
        }, 5000);
      } else {
        // Usar una imagen estática
        caracterElement = document.createElement("img");
        caracterElement.src =
          "https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-4.png"; // Siempre usar la imagen del nivel 4
        caracterElement.alt = `Ajolote Nivel ${level}`;
        caracterElement.className = "caracter";
        caracterElement.style.padding = "28.1px 0";
      }

      // Crear el elemento <div> para la descripción
      const caracterDescription = document.createElement("div");
      caracterDescription.className = "caracter-description";
      const spanElement = document.createElement("span");
      spanElement.textContent = "Wizard";
      caracterDescription.appendChild(spanElement);

      // Anidar elementos dentro del <div> principal
      caracterReachedLoop.appendChild(caracterElement);
      caracterReachedLoop.appendChild(caracterDescription);

      return caracterReachedLoop;
    }

    function handleLevelAnimation(level, isFirstTime) {
      if (isFirstTime) {
        // Ejecutar la animación solo si es la primera vez en el nivel especificado
        const lottiePlayer = document.getElementById(
          `ajolote-${level}-discover-animation`
        );
        if (lottiePlayer) {
          lottiePlayer.play();
        }
        setTimeout(() => {
          document.querySelector(".caracter-modal").style.display = "flex";
          setTimeout(() => {
            updateModalContent(level, hasFailed);
            document.querySelector(".caracter-modal").style.opacity = 1;
          }, 100);
        }, 5000);
      }
    }

    const AddEmptyLevelLoop = () => {
      //convertir a crear el elemento en vez de copiar el nodo ("esta creando uno rellenado")
      let progressBoxContainer = document.getElementById("progress-rewards");
      let progressCaracterContainer =
        document.querySelector(".caracter-column");
      let progressRewardsContainer = document.querySelector(
        ".progressBar-rewards"
      );
      // Crear el elemento <img>
      let progressEmptyBox = document.createElement("img");

      // Establecer atributos del elemento
      progressEmptyBox.id = "firstLoopChild";
      progressEmptyBox.className = "progress-loop-part";
      progressEmptyBox.src =
        "https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d01207fb0064661ab0/original.png?1723613647";
      progressEmptyBox.alt = "";
      let caracterContainer = document.createElement("div");

      // Establecer la clase para el <div>
      caracterContainer.className = "caracter-container";

      // Crear el elemento <lottie-player>
      let lottiePlayer = document.createElement("lottie-player");

      // Establecer atributos para <lottie-player>
      lottiePlayer.id = "ajolote-4-discover-animation";
      lottiePlayer.className = "caracter-animation caracter";
      lottiePlayer.setAttribute(
        "src",
        "https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
      );
      lottiePlayer.setAttribute("background", "transparent");
      lottiePlayer.setAttribute("speed", "1");
      lottiePlayer.setAttribute("direction", "2");
      lottiePlayer.setAttribute("mode", "normal");

      // Crear el elemento <div> para la descripción
      let caracterDescription = document.createElement("div");
      caracterDescription.className = "caracter-description";

      // Crear el elemento <span> dentro de la descripción
      let spanElement = document.createElement("span");
      spanElement.textContent = "Wizard";

      // Anidar el <span> dentro de la descripción
      caracterDescription.appendChild(spanElement);
      caracterContainer.appendChild(lottiePlayer);
      caracterContainer.appendChild(caracterDescription);

      // Crear el elemento <div> principal
      let rewardsLoop = document.createElement("div");

      // Establecer atributos para el <div>
      rewardsLoop.id = "rewards-loop";
      rewardsLoop.className = "lvl-4-rewards rewards rewards-loop";

      // Crear el elemento <p> y establecer su contenido
      let paragraph = document.createElement("p");
      paragraph.textContent = "Premios";

      // Crear el elemento <ul>
      let ulElement = document.createElement("ul");

      // Crear el primer elemento <li> y establecer su contenido
      let liCashback = document.createElement("li");
      liCashback.textContent = "cashback";

      // Crear el segundo elemento <li> y establecer su contenido
      let liMSI = document.createElement("li");
      liMSI.textContent = "MSI";

      // Anidar los elementos <li> dentro de <ul>
      ulElement.appendChild(liCashback);
      ulElement.appendChild(liMSI);

      // Anidar el <p> y el <ul> dentro del <div> principal
      rewardsLoop.appendChild(paragraph);
      rewardsLoop.appendChild(ulElement);

      let numElementos = progressBoxContainer.children.length;
      progressEmptyBox.style.zIndex = -numElementos;
      progressBoxContainer.appendChild(progressEmptyBox);
      progressCaracterContainer.appendChild(caracterContainer);
      progressRewardsContainer.appendChild(rewardsLoop);
    };

    function updateModalContent(level, hasFailed) {
      const modalTitle = document.getElementById("modal-title");
      const modal = document.querySelector(".caracter-modal");
      const lottieContainer = document.querySelector(".modal-lottie-container");
      const recompensaText = document.querySelector(".recompensa-description");
      const modalButton = document.getElementById("modal-button");
      const comercioSelector = document.querySelector(".comercios-container");
      const recompensaContainer = document.querySelector(
        ".recompensa-container"
      );
      if (hasFailed) {
        // Usar una imagen si falló
        modalTitle.textContent = `AJO te extraña`;
        const imgElement = document.createElement("img");
        imgElement.src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-${
          level >= 4 ? "1" : level
        }-TRISTE.png`; // Imagen de falla o imagen estática
        imgElement.alt = `Ajolote Nivel ${level}`;

        // Que no lo agregué así nomas, que añada el titulo, texto de la descripción y el botón
        lottieContainer.innerHTML = "";
        lottieContainer.appendChild(imgElement);
      } else {
        // Usar lottie-player si no falló
        modalTitle.innerHTML = `¡GANASTE!<br>Nivel ${level}`;
        comercioSelector.style.display = "none";
        recompensaContainer.style.marginBottom = "50px";
        const newLottiePlayer = document.createElement("lottie-player");
        const lottieSrc =
          level <= 4
            ? `https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-${level}-Animacion.json`
            : `https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-4-Animacion.json`;
        newLottiePlayer.setAttribute("src", lottieSrc);
        newLottiePlayer.setAttribute("background", "transparent");
        newLottiePlayer.setAttribute("speed", "1");
        newLottiePlayer.setAttribute("direction", "2");
        newLottiePlayer.setAttribute("mode", "normal");
        newLottiePlayer.setAttribute("autoplay", "true");
        newLottiePlayer.setAttribute("loop", "true");
        lottieContainer.innerHTML = "";
        lottieContainer.appendChild(newLottiePlayer);
        if (level >= 4 && comercio.length === 0) {
          comercioSelector.style.display = "flex";
          recompensaContainer.style.marginBottom = "0px";
          const images = document.querySelectorAll(".comercios-container img");
          images.forEach((image) => {
            image.addEventListener("click", function () {
              //Aquí se guarda la selección
              let comercioSeleccionado = image.id;
              console.log(comercioSeleccionado);
              images.forEach((img) => img.classList.remove("selected"));
              image.classList.add("selected");

              //para que el botón no este hasta que el usuario elija el cashback
              // document.getElementById("modal-button").style.display = "block";
            });
          });
          setTimeout(() => {
            // Hacer scroll al modal para que esté en la vista
            comercioSelector.scrollIntoView({ behavior: "smooth" });
          }, 1200);
        }
        //en este else poner el de seleccion en vez del modal
      }

      // Actualizar el texto de la recompensa
      recompensaText.textContent = premioActual; // Puedes hacer esto dinámico también

      // Actualizar el botón si es necesario
      modalButton.textContent = "Usar mi promo";

      // Mostrar el modal
      modal.style.display = "flex";
      setTimeout(() => {
        modal.style.opacity = 1;
      }, 100);
    }

    const AddReachedLevelLoop = (level, isFirstTime, hasFailed) => {
      const progressBoxContainer = document.getElementById("progress-rewards");
      const progressCaracterContainer =
        document.querySelector(".caracter-column");
      const progressRewardsContainer = document.querySelector(
        ".progressBar-rewards"
      );

      // -- Barra de progreso llena

      // Crear el elemento <img>
      // Crear el elemento <div>
      let infoTag = document.createElement("div");

      // Establecer la clase del elemento
      infoTag.className = "info-tag info-tag-newLevel";

      // Añadir el nuevo elemento al contenedor progressBoxContainer
      let progressFilledBoxContainer = document.createElement("div");
      progressFilledBoxContainer.className = "progressFilledBoxContainer";
      let progressEmptyBox = document.createElement("img");

      // Establecer atributos del elemento
      progressEmptyBox.id = "firstLoopFilledChild";
      progressEmptyBox.className = "progress-loop-part";
      progressEmptyBox.src =
        "https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d05e5ed80063b59f20/original.png?1723613648";
      progressEmptyBox.alt = "";

      let numElementos = progressBoxContainer.children.length;
      progressFilledBoxContainer.style.zIndex = -numElementos;
      progressFilledBoxContainer.appendChild(progressEmptyBox);
      progressFilledBoxContainer.appendChild(infoTag);
      progressBoxContainer.appendChild(progressFilledBoxContainer);

      // Añadir el evento click para mostrar el modal con el contenido dinámico
      progressEmptyBox.addEventListener("click", () => {
        updateModalContent(level, hasFailed);
      });

      infoTag.addEventListener("click", () => {
        openModalInfo()
      });

      // -- Añade personaje descubierto

      // Crear y añadir el elemento de nivel usando la función auxiliar
      const caracterReachedLoop = createLevelElement(level, isFirstTime);
      progressCaracterContainer.appendChild(caracterReachedLoop);

      //  -- Texto Recompensas

      // Crear el elemento <div> principal para recompensas
      const rewardsLoop = document.createElement("div");
      rewardsLoop.id = `rewards-loop-${level}`;
      rewardsLoop.className = "lvl-4-rewards rewards rewards-loop";

      // Crear el elemento <p> y establecer su contenido
      const paragraph = document.createElement("p");
      paragraph.textContent = "Premios";

      // Crear el elemento <ul>
      const ulElement = document.createElement("ul");

      // Crear los elementos <li> y establecer su contenido
      const liCashback = document.createElement("li");
      liCashback.textContent = "cashback";

      const liMSI = document.createElement("li");
      liMSI.textContent = "MSI";

      // Anidar los elementos <li> dentro de <ul>
      ulElement.appendChild(liCashback);
      ulElement.appendChild(liMSI);

      // Anidar el <p> y el <ul> dentro del <div> principal
      rewardsLoop.appendChild(paragraph);
      rewardsLoop.appendChild(ulElement);

      // Añadir elementos al DOM
      progressRewardsContainer.appendChild(rewardsLoop);
    };

    function showFirst4Levels(level) {
      for (let index = 1; index <= level; index++) {
        if (index > 4) return;
        const container = document.getElementById(`caracter-lvl-${index}`);
        container.style.marginTop = level == 1 ? "-10px" : "0px";
        const chestContainer = document.querySelector(`.chest-${index}`);
        const handleClickModal = () => {
          updateModalContent(index, hasFailed);
        };
        if (chestContainer)
          chestContainer.addEventListener("click", handleClickModal);
        if (container) container.addEventListener("click", handleClickModal);

        const lottiePlayer = document.getElementById(
          `ajolote-${index}-discover-animation`
        );
        // Verificar si es la primera vez en el nivel
        if (index === level && isFirstTime) {
          // Reproducir la animación si es la primera vez
          handleLevelAnimation(index, true);
          return; // Termina la función después de reproducir la animación
        } else {
          // Reemplazar el Lottie Player por una imagen si no es la primera vez
          const imgElement = document.createElement("img");

          // Establecer los atributos del nuevo <img>
          imgElement.id = `ajolote-${index}-discover-image`;
          imgElement.className = "caracter";
          imgElement.src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-${index}.png`; // Cambia la ruta a la imagen que quieres usar
          imgElement.alt = `Ajolote Nivel ${index}`;
          imgElement.style.padding = index == 1 ? "0 0 28.1px 0" : "28.1px 0";

          // Reemplazar el Lottie Player con la imagen
          container.replaceChild(imgElement, lottiePlayer);
        }
      }
    }
    const generateNewLevel = (level) => {
      if (level < 4) {
        document.querySelector(
          ".progressBar"
        ).src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-${level}.png`;
        showFirst4Levels(level);
        return;
      }

      if (level >= 4) {
        document.querySelector(
          ".progressBar"
        ).src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-4.png`;
        showFirst4Levels(level);
        const currentLevel = level - 4;
        for (let index = 1; index <= currentLevel; index++) {
          if (index == currentLevel) {
            AddReachedLevelLoop(level, isFirstTime ? true : false, hasFailed);
            AddEmptyLevelLoop();
            return;
          }
          AddReachedLevelLoop(level, false);
        }
      }
      AddEmptyLevelLoop();
    };
    generateNewLevel(Nivel);
  </script>
</html>
