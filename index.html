<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0, viewport-fit=cover"
    />
    <title>RappiCard Legacy</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="https://braze-images.com/appboy/communication/assets/code_assets/files/66c0ea4acf09fa0064008240/original.css?1723918922" />
  </head>
  <body>
    <div class="main-container">
      <img
        class="background"
        src="https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d3d0d80700634db9fb/original.png?1723613648"
        alt=""
      />
      <img
        class="close-button"
        src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027bea2ace80063aba43a/original.svg?1723869118"
        onclick="brazeBridge.logClick('Cerrar_pantalla');brazeBridge.closeMessage()"
      />
      <div class="caracter-modal">
        <!-- Este es el modal, solo se renderiza en ciertos momentos-->
        <img
          class="background"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d3d0d80700634db9fb/original.png?1723613648"
          alt=""
        />
        <img
          src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027bea2ace80063aba43a/original.svg?1723869118"
          id="close-button-modal"
          class="close-button"
        />
        <p class="caracter-modal-title" id="modal-title">¡GANASTE!</p>
        <div class="modal-lottie-container">
          <!-- Este es el modal, solo se renderiza en ciertos momentos-->
          <lottie-player
            class="modal-lottie"
            id="Ajolote-Level-1-Animacion"
            src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-2-Animacion.json"
            background="transparent"
            speed="1"
            direction="2"
            mode="normal"
            autoplay
            loop
          ></lottie-player>
        </div>
        <div class="recompensa-container">
          <!-- Este es el modal, solo se renderiza en ciertos momentos-->
          <p class="title">Recompensa</p>
          <hr />
          <div class="recompensa-description">
            <p>Ganaste 3% de cashback en tu siguinete compra</p>
          </div>
        </div>
        <div class="comercios-container">
          <!-- Este es el modal, solo se renderiza en ciertos momentos-->
          <div id="Gasolina" class="comercios"><p>Gasolina</p></div>
          <div id="Farmacias" class="comercios"><p>Farmacias</p></div>
          <div id="Uber" class="comercios"><p>Uber</p></div>
          <div id="Conveniencia" class="comercios"><p>Conveniencia</p></div>
          <div id="Supermercado" class="comercios"><p>Supermercados</p></div>
        </div>
        <button class="modal-button" id="modal-button">Usar mi promo</button>
      </div>
      <div class="modal-overlay"></div>
      <div class="modal-info">
        <img
          src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027bef7d0e900659c59b3/original.svg?1723869118"
          id="close-modal-info"
          style="color: black; float: right"
        />
        <div class="text-info-container">
          <p>Has ganado:</p>
          <p id="premio-info-container"></p>
          <img
            id="chest-info-container"
            src="https://growth-cdn.business-systems-rappicard.mx/Gamification/cofre-nivel-1.png"
            alt=""
          />
        </div>
        <p class="tyc">Aplican <a href="www.google.com">TyC</a></p>
      </div>
      <!-- Inician los niveles -->
      <div class="mainPage-container">
        <img
          class="img-title"
          src="https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41cffbc3f20064c786a6/original.png?1723613647"
          alt=""
        />
        <!-- Aquí va la mnisión actual, la variable -->
        <div class="mision-actual-container">
          <p class="mision-header">Completa tu misión</p>
          <!-- Aquí cambiar el título de misión actual-->
          <hr />
          <!--- Esta es la línea-->
          <p id="meta-actual-text">...</p>
          <!--- Esta es la meta actual, como variable-->
        </div>
        <!--Este es el div de todos los progress bar y monitos y todo-->
        <div class="progress-container">
          <!--Este div agarra solo el div de los avatares-->
          <div class="column caracter-column">
            <!---Aquí entra con la variable if (index === level && isFirstTime) {-->
            <div id="caracter-lvl-1" class="caracter-container">
              <!--Aquí es donde entra la función createLevelElement donde trae la inf--->
              <lottie-player
                id="ajolote-1-discover-animation"
                class="caracter-animation caracter"
                src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-1-Icono.json"
                background="transparent"
                speed="1"
                direction="2"
                mode="normal"
              ></lottie-player>
              <div class="caracter-description">
                <span>Aprendiz (nivel 1)</span>
              </div>
            </div>
            <div id="caracter-lvl-2" class="caracter-container">
              <lottie-player
                id="ajolote-2-discover-animation"
                class="caracter-animation caracter"
                src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-2-Icono.json"
                background="transparent"
                speed="1"
                direction="2"
                mode="normal"
              ></lottie-player>
              <div class="caracter-description">
                <span>Hechicero (nivel 2)</span>
              </div>
            </div>
            <div id="caracter-lvl-3" class="caracter-container">
              <lottie-player
                id="ajolote-3-discover-animation"
                class="caracter-animation caracter"
                src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-3-Icono.json"
                background="transparent"
                speed="1"
                direction="2"
                mode="normal"
              ></lottie-player>
              <div class="caracter-description">
                <span>Mago (nivel 3)</span>
              </div>
            </div>
            <div id="caracter-lvl-4" class="caracter-container">
              <lottie-player
                id="ajolote-4-discover-animation"
                class="caracter-animation caracter"
                src="https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
                background="transparent"
                speed="1"
                direction="2"
                mode="normal"
              ></lottie-player>
              <div class="caracter-description">
                <span>Gran Mago (nivel 4)</span>
              </div>
            </div>
          </div>
          <div class="column rewards-column">
            <div id="progress-rewards" class="progress">
              <img
                src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027be4e8bd3006498e88d/original.svg?1723869118"
                class="info-tag tag-1"
                onclick="openModalInfo(1)"
              />
              <div class="chest chest-1"></div>
              <img
                src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027be4e8bd3006498e88d/original.svg?1723869118"
                class="info-tag tag-2"
                onclick="openModalInfo(2)"
              />
              <div class="chest chest-2"></div>
              <img
                src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027be4e8bd3006498e88d/original.svg?1723869118"
                class="info-tag tag-3"
                onclick="openModalInfo(3)"
              />
              <div class="chest chest-3"></div>
              <img
                src="https://braze-images.com/appboy/communication/assets/svg_assets/files/66c027be4e8bd3006498e88d/original.svg?1723869118"
                class="info-tag tag-4"
                onclick="openModalInfo(4)"
              />
              <div class="chest chest-4"></div>
              <img
                class="progressBar"
                src="https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-2.png"
                alt=""
              />
            </div>
            <div class="progressBar-rewards">
              <div class="lvl-1-rewards rewards">
                <!--<p>Premios</p>
                <ul>
                  <li>cashback</li>
                  <li>MSI</li>
                </ul>-->
              </div>
              <div class="lvl-2-rewards rewards">
                <!--<p>Premios</p>
                <ul>
                  <li>cashback</li>
                  <li>MSI</li>
                </ul>-->
              </div>
              <div class="lvl-3-rewards rewards">
                <!--<p>Premios</p>
                <ul>
                  <li>cashback</li>
                  <li>MSI</li>
                </ul>-->
              </div>
              <div class="lvl-4-rewards rewards">
                <!--<p>Premios</p>
                <ul>
                  <li>cashback</li>
                  <li>MSI</li>
                </ul>-->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <!-- script de campañas -->
  <script src="https://braze-images.com/appboy/communication/assets/code_assets/files/66c0eab2dc2c970063788dd4/original.js?1723919026"></script>
  <script>
    // Objeto que rellena toda la información de la app
    // --------------------------------------
    let object = {
      resultado: {
        isFirstTime: false /* boleano */,
        Logros: {
          Nivel: 6 /* Entero mayor a 0 */, // Aquí es donde se pone el nivel actual
          hasFailed: false /* boleano */,
          semana: 1 /* Entero mayor a 0 */,
          comercio: "" /* String */,
        },
      },
      premioActual: "Elige un comercio donde quieras cashback" /* String */,
      urlPremioActual: "https://www.youtube.com",
      metaActual:
        "Realiza 5 transacciones. Tienes hasta el 20 de agosto" /* String  Aquí es donde le ponemos la meta actual */,
      premios: {
        1: {premio: "Ganaste Premio 1", urlPromo:"https://www.google.com"},
        2: {premio: "Ganaste Premio 2", urlPromo:"https://www.google.com"},
        3: {premio: "Ganaste Premio 3", urlPromo:"https://www.google.com"},
        4: {premio: "Ganaste Premio 4", urlPromo:"https://www.google.com"},
        5: {premio: "Ganaste Premio 5", urlPromo:"https://www.google.com"},
      },
    };
    // --------------------------------------
 //Aquí saco todas las variables que necesito sin para tener código más limpio
    const { Nivel, hasFailed, semana, comercio } = object.resultado.Logros;
    const { premioActual, urlPremioActual, metaActual, premios } = object;
    const { isFirstTime } = object.resultado;

    //Variable que redirecciona al usuario a su promo:
    let UrlPromo = 'https://www.google.com'

    const caracterModal = document.querySelector(".caracter-modal");
    document.getElementById("meta-actual-text").innerText =
      metaActual; /* Aquí es cuando se agarra la variable para meta actual */
    document
      .getElementById("close-button-modal")
      .addEventListener("click", () => {
        caracterModal.style.opacity = 0;
        setTimeout(() => {
          caracterModal.style.display = "none";
        }, 250);
      });
    const modalInfoCloseButton = document.getElementById("close-modal-info");
    modalInfoCloseButton.addEventListener("click", closeModalInfo);

    function inscriptionApiRewards(promoSeleccionada) {
      console.log(promoSeleccionada);
      let campañaAsignada = campañas[promoSeleccionada];
      console.log(campañaAsignada);
      const rewardsAPI = () => {
        let result = fetch(
          "https://rewards-mx.dev-k8s.rappipay.com.mx/rewards/mx/btb/api/v1/MX/campaigns/wl/list-users",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization:
                "Basic cnBwLWdyb3d0aC1yYXBwaS1jYXJkLW14LWhvdC1zYWxlOjNhOWU1YzYwZDNmN2I4ZWE4OGUxMjc5N2JhZjZmOGRl",
            },
            body: JSON.stringify([
              {
                user_id: "88b3e180-788c-43a3-b5fa-c67d025a16f3",
                campaign_id: campañaAsignada.post,
                type_list: "WL",
                active: true,
              },
              {
                user_id: "88b3e180-788c-43a3-b5fa-c67d025a16f3",
                campaign_id: campañaAsignada.refund,
                type_list: "WL",
                active: true,
              },
            ]),
          }
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            console.log(data);
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation: ",
              error
            );
          });
      };
      // rewardsAPI()
    }
    // Este es para las i de información de las metas
    function openModalInfo(currentLevel) {
      modalInfo = document.querySelector(".modal-info");
      overlay = document.querySelector(".modal-overlay");
      modalInfo.style.opacity = 1;
      overlay.style.opacity = 1;
      modalInfo.style.display = "block";
      overlay.style.display = "block";
      document.getElementById("premio-info-container").textContent =
        premios[currentLevel].premio;
      document.getElementById("chest-info-container").src =
        currentLevel >= 4
          ? `https://growth-cdn.business-systems-rappicard.mx/Gamification/cofre-nivel-4.png`
          : `https://growth-cdn.business-systems-rappicard.mx/Gamification/cofre-nivel-${currentLevel}.png`;
    }
    function closeModalInfo() {
      modalInfo = document.querySelector(".modal-info");
      overlay = document.querySelector(".modal-overlay");
      modalInfo.style.opacity = 0;
      overlay.style.opacity = 0;
      setTimeout(() => {
        modalInfo.style.display = "none";
        overlay.style.display = "none";
      }, 500);
    }

    // Este es la función que va creando los niveles
    function createLevelElement(level, isFirstTime) {
      // Crear el elemento <div> principal
      const caracterReachedLoop = document.createElement("div");
      // Aquí es cuando con el click abre el modal, aquí es donde agregaríamos el log click
      caracterReachedLoop.addEventListener("click", () => {
        updateModalContent(level, hasFailed);
      });
      caracterReachedLoop.id = `caracter-reached-loop-${level}`;
      caracterReachedLoop.className = "caracter-container caracter-loop";

      // Crear el elemento de caracter para los niveles 4 o más imagen esta´tica o con animación
      let caracterElement;
      if (isFirstTime) {
        // Usar lottie-player si es la primera vez aquí viene la lógica de si ya lo vio o no
        caracterElement = document.createElement("lottie-player");
        caracterElement.setAttribute(
          "id",
          `ajolote-${level}-discover-animation`
        );
        caracterElement.setAttribute(
          "src",
          "https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
        ); // Siempre usar el JSON del nivel 4
        caracterElement.setAttribute("background", "transparent");
        caracterElement.setAttribute("speed", "1");
        caracterElement.setAttribute("direction", "1");
        caracterElement.setAttribute("mode", "normal");
        caracterElement.setAttribute("autoplay", "true");
        // Aquí es cuando le das el timeout para el modal de animación, retraso de 5 segundos para mostrar modal
        setTimeout(() => {
          document.querySelector(".caracter-modal").style.display = "flex";
          setTimeout(() => {
            updateModalContent(level, hasFailed);
            document.querySelector(".caracter-modal").style.opacity = 1;
          }, 100);
        }, 5000);
      } else {
        // Usar una imagen estática
        caracterElement = document.createElement("img");
        caracterElement.src =
          "https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-4.png"; // Siempre usar la imagen del nivel 4
        caracterElement.alt = `Ajolote Nivel ${level}`;
        caracterElement.className = "caracter";
        caracterElement.style.padding = "28.1px 0";
      }

      // Crear el elemento <div> para la descripción
      const caracterDescription = document.createElement("div");
      caracterDescription.className = "caracter-description";
      const spanElement = document.createElement("span");
      spanElement.textContent = `Gran Mago (nivel ${level})`; // Wizard se queda pa 4+
      caracterDescription.appendChild(spanElement);

      // Anidar elementos dentro del <div> principal
      caracterReachedLoop.appendChild(caracterElement);
      caracterReachedLoop.appendChild(caracterDescription);

      return caracterReachedLoop;
    }
    // Esta es la animación para un nivel específico cuando apenas se abre
    function handleLevelAnimation(level, isFirstTime) {
      if (isFirstTime) {
        // Ejecutar la animación solo si es la primera vez en el nivel especificado
        const lottiePlayer = document.getElementById(
          `ajolote-${level}-discover-animation`
        );
        if (lottiePlayer) {
          lottiePlayer.play();
        }
        setTimeout(() => {
          document.querySelector(".caracter-modal").style.display = "flex";
          setTimeout(() => {
            updateModalContent(level, hasFailed);
            document.querySelector(".caracter-modal").style.opacity = 1;
          }, 100);
        }, 5000);
      }
    }
    // Este es para el siguiente nivel que parezca sin rellenar
    const AddEmptyLevelLoop = () => {
      //convertir a crear el elemento en vez de copiar el nodo ("esta creando uno rellenado")
      let progressBoxContainer = document.getElementById("progress-rewards");
      let progressCaracterContainer =
        document.querySelector(".caracter-column");
      let progressRewardsContainer = document.querySelector(
        ".progressBar-rewards"
      );
      // Crear el elemento <img>
      let progressEmptyBox = document.createElement("img");

      // Establecer atributos del elemento
      progressEmptyBox.id = "firstLoopChild";
      progressEmptyBox.className = "progress-loop-part";
      progressEmptyBox.src =
        "https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d01207fb0064661ab0/original.png?1723613647";
      progressEmptyBox.alt = "";
      let caracterContainer = document.createElement("div");

      // Establecer la clase para el <div>
      caracterContainer.className = "caracter-container";

      // Crear el elemento <lottie-player>
      let lottiePlayer = document.createElement("lottie-player");

      // Establecer atributos para <lottie-player>
      lottiePlayer.id = "ajolote-4-discover-animation";
      lottiePlayer.className = "caracter-animation caracter";
      lottiePlayer.setAttribute(
        "src",
        "https://growth-cdn.business-systems-rappicard.mx/Gamification/Nivel-4-Icono.json"
      );
      lottiePlayer.setAttribute("background", "transparent");
      lottiePlayer.setAttribute("speed", "1");
      lottiePlayer.setAttribute("direction", "2");
      lottiePlayer.setAttribute("mode", "normal");

      // Crear el elemento <div> para la descripción
      let caracterDescription = document.createElement("div");
      caracterDescription.className = "caracter-description";

      // Crear el elemento <span> dentro de la descripción
      let spanElement = document.createElement("span");
      spanElement.textContent = `Gran Mago (Nivel ${Nivel + 1})`;

      // Anidar el <span> dentro de la descripción
      caracterDescription.appendChild(spanElement);
      caracterContainer.appendChild(lottiePlayer);
      caracterContainer.appendChild(caracterDescription);

      // Crear el elemento <div> principal
      let rewardsLoop = document.createElement("div");

      // Establecer atributos para el <div>
      rewardsLoop.id = "rewards-loop";
      rewardsLoop.className = "lvl-4-rewards rewards rewards-loop";

      // Crear el elemento <p> y establecer su contenido
      let paragraph = document.createElement("p");
      paragraph.textContent = "Premios";

      // Crear el elemento <ul>
      let ulElement = document.createElement("ul");

      // Crear el primer elemento <li> y establecer su contenido
      let liCashback = document.createElement("li");
      liCashback.textContent = "cashback";

      // Crear el segundo elemento <li> y establecer su contenido
      let liMSI = document.createElement("li");
      liMSI.textContent = "?";

      // Anidar los elementos <li> dentro de <ul> --- Comentado por Cas para uqe ya no salgan la descripción de los premios en la pantalla pricnipal
      /*  ulElement.appendChild(liCashback);
      ulElement.appendChild(liMSI);

      // Anidar el <p> y el <ul> dentro del <div> principal -
      rewardsLoop.appendChild(paragraph);
      rewardsLoop.appendChild(ulElement);*/

      let numElementos = progressBoxContainer.children.length;
      progressEmptyBox.style.zIndex = -numElementos;
      progressBoxContainer.appendChild(progressEmptyBox);
      progressCaracterContainer.appendChild(caracterContainer);
      progressRewardsContainer.appendChild(rewardsLoop);
    };
    // Aquí decide su has failed = true entonce sale en todos el ajolote triste, auqí es donde cambiaría la imagen para cada uno
    function updateModalContent(level, hasFailed) {
      const modalTitle = document.getElementById("modal-title");
      const modal = document.querySelector(".caracter-modal");
      const lottieContainer = document.querySelector(".modal-lottie-container");
      const recompensaText = document.querySelector(".recompensa-description");
      const modalCloseButton = document.getElementById("close-button-modal");
      const modalButton = document.getElementById("modal-button");
      const comercioSelector = document.querySelector(".comercios-container");
      const recompensaContainer = document.querySelector(
        ".recompensa-container"
      );
      let action = "redireccionar";
      let promoSeleccionada = "";

      if (hasFailed) {
        // Usar una imagen si falló, si es mayopr a 4 simpre regresa el ajolote número 1
        modalTitle.textContent = `AJO te extraña`; // Aquí es donde cambiaremos el header de fallo
        const imgElement = document.createElement("img");
        imgElement.src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-${
          level >= 4 ? "3" : level /// Modificación Cas de cambiar 1 por 3 en lo que está el ajolote triste nivel 4
        }-TRISTE.png`; // Imagen de falla o imagen estática
        imgElement.alt = `Ajolote Nivel ${level}`;

        // Que no lo agregué así nomas, que añada el titulo, texto de la descripción y el botón
        lottieContainer.innerHTML = "";
        lottieContainer.appendChild(imgElement);
      } else {
        // Usar lottie-player si no falló si es un novel abajo de 4 se muetrsa el de 4, si es 4 o más se muetsra el de 4
        modalTitle.innerHTML = `¡GANASTE!<br>Nivel ${level}`; /// Modificación Cas de cambiarlo a current level (Esta es la parte que tampoco me sale, me sale solo el ultimo nivel no el correspondiente aor acada nivel)
        comercioSelector.style.display = "none";
        recompensaContainer.style.marginBottom = "50px";
        const newLottiePlayer = document.createElement("lottie-player");
        const lottieSrc =
          level <= 4
            ? `https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-${level}-Animacion.json`
            : `https://growth-cdn.business-systems-rappicard.mx/Gamification/Ajolote-Nivel-4-Animacion.json`;
        newLottiePlayer.setAttribute("src", lottieSrc);
        newLottiePlayer.setAttribute("background", "transparent");
        newLottiePlayer.setAttribute("speed", "1");
        newLottiePlayer.setAttribute("direction", "2");
        newLottiePlayer.setAttribute("mode", "normal");
        newLottiePlayer.setAttribute("autoplay", "true");
        newLottiePlayer.setAttribute("loop", "true");
        lottieContainer.innerHTML = "";
        lottieContainer.appendChild(newLottiePlayer);

        // Este if level >= 4 and comercio debe ca,biar por si la meta le toca desde el nivel 1.
        //if (level >= 4 && comercio.length === 0) {
        if (
          level === Nivel &&
          metaActual.includes("transacciones. Tienes hasta") &&
          comercio.length === 0
        ) {
          // Modificación Cas, el usuario puede ser que pueda elegir desde nivel 1, y solo le salga si está en el nivel actual (Esta es la parte que no me sale :C, que que oslo salga en el nivel actual, me salen en todos )
          modalCloseButton.style.display = "none";
          modalButton.style.opacity = 0;
          action = "registrarApi";
          comercioSelector.style.display = "flex";
          recompensaContainer.style.marginBottom = "0px";
          const images = document.querySelectorAll(".comercios-container div");
          images.forEach((image) => {
            image.addEventListener("click", function () {
              //Aquí se guarda la selección
              promoSeleccionada = image.id;
              images.forEach((img) => img.classList.remove("selected"));
              image.classList.add("selected");
              modalButton.style.opacity = 1;
            });
          });
          setTimeout(() => {
            // Hacer scroll al modal para que esté en la vista
            comercioSelector.scrollIntoView({ behavior: "smooth" });
          }, 1200);
        } else {
          // Añadido por Cas para que solo si es click en el modal de nivel actual se abra lo de comercios Si no es el nivel actual, mostrar premios históricos, Este tampo me sale :(
          recompensaText.textContent = premioActual;
        }
        //en este else poner el de seleccion en vez del modal
      }
      // Actualizar el texto de la recompensa
      recompensaText.textContent =
        level == Nivel ? premioActual : premios[level].premio; // Auqí es donde está la aprte de premio, de cada nivel, modificación Cas. Igual no se qéu se le tien que mover

      // Actualizar el botón si es necesario
      modalButton.textContent = "Usar mi promo"; 
      modalButton.addEventListener("click", () => {
        if (action === "redireccionar") {
          brazeBridge.logClick("redireccion_promo");
          // Redirigir a una URL específica
          window.location.href = level == Nivel ? urlPremioActual : premios[level].urlPromo;
        } else if (action === "registrarApi") {
          brazeBridge.logClick(promoSeleccionada);
          inscriptionApiRewards(promoSeleccionada);
        }
      });

      // Mostrar el modal
      modal.style.display = "flex";
      setTimeout(() => {
        modal.style.opacity = 1;
      }, 100);
    }
    // Ahora este va añadiendo el nivel que va el usaurio, para los 4+
    const AddReachedLevelLoop = (level, isFirstTime, hasFailed) => {
      const progressBoxContainer = document.getElementById("progress-rewards");
      const progressCaracterContainer =
        document.querySelector(".caracter-column");
      const progressRewardsContainer = document.querySelector(
        ".progressBar-rewards"
      );

      // -- Barra de progreso llena

      // Crear el elemento <img>
      // Crear el elemento <div>
      let infoTag = document.createElement("img");

      // Establecer la clase del elemento
      infoTag.className = "info-tag info-tag-newLevel";
      infoTag.src = "./icono-info.svg";

      // Añadir el nuevo elemento al contenedor progressBoxContainer
      let progressFilledBoxContainer = document.createElement("div");
      progressFilledBoxContainer.className = "progressFilledBoxContainer";
      let progressEmptyBox = document.createElement("img");

      // Establecer atributos del elemento
      progressEmptyBox.id = "firstLoopFilledChild";
      progressEmptyBox.className = "progress-loop-part";
      progressEmptyBox.src =
        "https://braze-images.com/appboy/communication/assets/image_assets/images/66bc41d05e5ed80063b59f20/original.png?1723613648";
      progressEmptyBox.alt = "";

      let numElementos = progressBoxContainer.children.length;
      progressFilledBoxContainer.style.zIndex = -numElementos;
      progressFilledBoxContainer.appendChild(progressEmptyBox);
      progressFilledBoxContainer.appendChild(infoTag);
      progressBoxContainer.appendChild(progressFilledBoxContainer);

      // Añadir el evento click para mostrar el modal con el contenido dinámico
      progressEmptyBox.addEventListener("click", () => {
        updateModalContent(level, hasFailed);
      });

      infoTag.addEventListener("click", () => {
        openModalInfo(level);
      });

      // -- Añade personaje descubierto

      // Crear y añadir el elemento de nivel usando la función auxiliar
      const caracterReachedLoop = createLevelElement(level, isFirstTime);

      // Modificación para asignar el nivel correcto --- modificación Cas
      const spanElement = caracterReachedLoop.querySelector(
        ".caracter-description span"
      );
      if (spanElement) {
        spanElement.textContent = `Gran Mago (nivel ${level})`; // Asigna el nivel correspondiente
      }

      progressCaracterContainer.appendChild(caracterReachedLoop);

      //  -- Texto Recompensas

      // Crear el elemento <div> principal para recompensas
      const rewardsLoop = document.createElement("div");
      rewardsLoop.id = `rewards-loop-${level}`;
      rewardsLoop.className = "lvl-4-rewards rewards rewards-loop";

      // Crear el elemento <p> y establecer su contenido
      const paragraph = document.createElement("p");
      paragraph.textContent = "Premios";

      // Crear el elemento <ul>
      const ulElement = document.createElement("ul");

      // Crear los elementos <li> y establecer su contenido
      const liCashback = document.createElement("li");
      liCashback.textContent = "cashback";

      const liMSI = document.createElement("li");
      liMSI.textContent = "MSI";

      // Anidar los elementos <li> dentro de <ul> --- Comentado por Cas para uqe ya no salgan la descripción de los premios en la pantalla pricnipal
      /* ulElement.appendChild(liCashback);
      ulElement.appendChild(liMSI);

      // Anidar el <p> y el <ul> dentro del <div> principal
      rewardsLoop.appendChild(paragraph);
      rewardsLoop.appendChild(ulElement);*/

      // Añadir elementos al DOM
      progressRewardsContainer.appendChild(rewardsLoop);
    };
    // Esta es la parte que se va a cambiando según el valor que le de al nivel de los primeros 4 niveles
    function showFirst4Levels(level) {
      for (let index = 1; index <= level; index++) {
        if (index > 4) return;
        const container = document.getElementById(`caracter-lvl-${index}`);
        container.style.marginTop = level == 1 ? "-10px" : "0px";
        const chestContainer = document.querySelector(`.chest-${index}`);
        const handleClickModal = () => {
          updateModalContent(index, hasFailed);
        };
        if (chestContainer)
          chestContainer.addEventListener("click", handleClickModal);
        if (container) container.addEventListener("click", handleClickModal);

        const lottiePlayer = document.getElementById(
          `ajolote-${index}-discover-animation`
        );
        // Verificar si es la primera vez en el nivel
        if (index === level && isFirstTime) {
          // Reproducir la animación si es la primera vez
          handleLevelAnimation(index, true);
          return; // Termina la función después de reproducir la animación
        } else {
          // Reemplazar el Lottie Player por una imagen si no es la primera vez
          const imgElement = document.createElement("img");

          // Establecer los atributos del nuevo <img>
          imgElement.id = `ajolote-${index}-discover-image`;
          imgElement.className = "caracter";
          imgElement.src = `https://growth-cdn.business-systems-rappicard.mx/Gamification/AJO-LVL-${index}.png`; // Cambia la ruta a la imagen que quieres usar
          imgElement.alt = `Ajolote Nivel ${index}`;
          imgElement.style.padding = index == 1 ? "0 0 28.1px 0" : "28.1px 0";

          // Reemplazar el Lottie Player con la imagen
          container.replaceChild(imgElement, lottiePlayer);
        }
      }
    }
    // Crea un nuevo nivel (Este s ocmo el general , si mi nivel es menor a 4 toma el de fuirst level y si no, hace un loop y usa la función add reched level loop )
    const generateNewLevel = (level) => {
      showFirst4Levels(level);
      document.querySelector(".progressBar").src =
        level < 4
          ? `https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-${level}.png`
          : `https://growth-cdn.business-systems-rappicard.mx/Gamification/progressBar-Level-4.png`;

      if (level >= 4) {
        for (let index = 5; index <= level; index++) {
          if (index === level) {
            AddReachedLevelLoop(level, isFirstTime ? true : false, hasFailed);
            AddEmptyLevelLoop();
            return;
          }
          AddReachedLevelLoop(index, false);
        }
      }
      AddEmptyLevelLoop();
    };
    generateNewLevel(Nivel);
  </script>
</html>
